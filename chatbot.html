<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicAssist Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
        #chat-history::-webkit-scrollbar-track { background-color: #1f2937; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .option-button {
            display: block; width: 100%; text-align: left; padding: 12px 16px;
            margin-bottom: 8px; border-radius: 10px; background-color: #374151;
            color: white; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .option-button:hover { background-color: #4b5563; transform: translateY(-2px); border-left: 4px solid #6366f1; }
        .camera-container { width: 100%; border-radius: 12px; overflow: hidden; margin-top: 10px; border: 2px solid #4b5563; }
        #video-feed { width: 100%; background: #000; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex flex-col h-[85vh] md:h-[750px]">
        <div class="p-4 bg-indigo-700 text-white shadow-md flex items-center">
            <h1 class="text-lg font-bold">CivicBot ğŸ¤–</h1>
            <p class="ml-auto text-xs opacity-75">Online</p>
        </div>

        <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4"></div>

        <div id="input-area" class="p-4 bg-gray-700 border-t border-gray-600">
            <div class="flex items-center gap-2">
                <input type="text" id="user-input" placeholder="Type your name..."
                       class="flex-grow p-3 rounded-lg bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="handleInput()" id="send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        let chatStep = 0;
        let userName = '';
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');

        function addMessage(sender, content, isHtml = false) {
            const messageDiv = document.createElement('div');
            const isBot = sender === 'bot';
            messageDiv.className = `flex ${isBot ? 'justify-start' : 'justify-end'} mb-4`;
            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-[85%] p-3 rounded-xl ${isBot ? 'bg-gray-700 text-white rounded-tl-none' : 'bg-indigo-600 text-white rounded-br-none'}`;
            const body = document.createElement('div');
            body.className = "text-sm";
            if(isHtml) body.innerHTML = content; else body.textContent = content;
            contentDiv.appendChild(body);
            messageDiv.appendChild(contentDiv);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        window.onload = () => {
            addMessage('bot', "Hello! I am CivicBot. How can I help you today?");
            setTimeout(() => { addMessage('bot', "What is your name?"); chatStep = 1; }, 800);
        };

        function handleInput() {
            const val = userInput.value.trim();
            if (!val) return;
            addMessage('user', val);
            userInput.value = '';
            setTimeout(() => {
                if (chatStep === 1) {
                    userName = val;
                    addMessage('bot', `Nice to meet you, ${userName}!`);
                    showMainMenu();
                }
            }, 800);
        }

        function showMainMenu() {
            chatStep = 2;
            const menu = `
                <div class="space-y-2 mt-2">
                    <button class="option-button" onclick="reportIssue()">ğŸ“¢ Reporting an Issue</button>
                    <button class="option-button" onclick="openCamera()">ğŸ“¸ Image Analysis (AI Scan)</button>
                    <button class="option-button" onclick="showServices()">ğŸ“ Nearby Services</button>
                    <button class="option-button" onclick="showFacts()">ğŸ“ Civic Education</button>
                </div>`;
            addMessage('bot', "Choose an option:", true);
            addMessage('bot', menu, true);
        }

        // --- THE INTEGRATION PART ---
        window.reportIssue = () => {
            addMessage('user', "I want to report an issue.");
            const reportLink = `
                <div class="bg-indigo-900 p-4 rounded-lg border border-indigo-400 mt-2 text-center">
                    <p class="mb-3 text-white">I have generated your personalized report form.</p>
                    <a href="report.html" class="inline-block bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-full transition-all">
                        Open Report Page â†’
                    </a>
                </div>`;
            addMessage('bot', reportLink, true);
            setTimeout(askForContinuation, 3000);
        };

        // Camera Logic
        window.openCamera = () => {
            addMessage('bot', "Activating AI Scanner...", true);
            const camBox = `<div class="camera-container"><video id="video-feed" autoplay playsinline></video>
                <button onclick="analyzeImage()" class="w-full bg-indigo-600 p-3 text-white font-bold">SCAN NOW</button></div>`;
            addMessage('bot', camBox, true);
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => { document.getElementById('video-feed').srcObject = stream; })
                .catch(() => { addMessage('bot', "Camera access denied."); });
        };

        window.analyzeImage = () => {
            addMessage('bot', "AI identifying issues... ğŸ”");
            setTimeout(() => {
                addMessage('bot', "âœ… Pothole detected! You should submit a report.");
                askForContinuation();
            }, 2000);
        };

        // Services Dropdown
        window.showServices = () => {
            const dropdown = `<select onchange="findService(this.value)" class="w-full p-3 bg-gray-900 text-white rounded-lg border border-indigo-500 mt-2">
                <option value="">-- Choose Service --</option>
                <option value="Dustbins">ğŸ—‘ï¸ Dustbins</option>
                <option value="Hospitals">ğŸ¥ Hospitals</option>
                <option value="Water">ğŸš° Water ATMs</option>
            </select>`;
            addMessage('bot', "Select nearby service:", true);
            addMessage('bot', dropdown, true);
        };

        window.findService = (val) => {
            if(!val) return;
            addMessage('bot', `Finding nearest ${val}... ğŸ“`);
            setTimeout(askForContinuation, 1500);
        };

        // Facts
        window.showFacts = () => {
            const facts = ["RTI allows you to track govt progress.", "Sorting waste saves city energy.", "Participatory budgeting lets you vote on city spending."];
            addMessage('bot', `ğŸ’¡ Fact: ${facts[Math.floor(Math.random()*facts.length)]}`);
            setTimeout(askForContinuation, 2000);
        };

        function askForContinuation() {
            const btns = `<div class="flex gap-2 mt-2">
                <button onclick="showMainMenu()" class="bg-green-600 p-2 rounded flex-1">Yes, Menu</button>
                <button onclick="endSession()" class="bg-red-600 p-2 rounded flex-1">No, Done</button>
            </div>`;
            addMessage('bot', "Anything else?", true);
            addMessage('bot', btns, true);
        }

        window.endSession = () => { addMessage('bot', "Goodbye! Have a nice day."); userInput.disabled = true; };
    </script>
</body>
</html>